<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRỢ LÝ THIẾT KẾ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- KHO FONT CHỮ MỚI ĐƯỢC CẬP NHẬT THEO YÊU CẦU -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Be+Vietnam+Pro:wght@700&family=Playfair+Display:wght@900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #4f46e5; border-radius: 50%; width: 60px; height: 60px; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Styling cho các lựa chọn được check */
        .choice-selector input:checked + label {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
        }
        .color-swatch {
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 9999px;
            border: 2px solid rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .choice-selector input:checked + label .color-swatch {
            transform: scale(1.2);
        }
        .modal {
            transition: opacity 0.25s ease;
        }
    </style>
</head>
<body class="bg-[#fffbbe]">

    <main class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-8 my-8">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600" style="font-family: 'Playfair Display', serif;">TRỢ LÝ THIẾT KẾ 3</h1>
            <p class="text-gray-500 mt-2">Hỗ trợ các Sư Huynh Hoằng Pháp Lợi Sanh.</p>
        </header>

        <!-- 1. Tùy chỉnh -->
        <section>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Bước 1: Tùy Chỉnh Phong Cách</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Cột trái: Văn bản chính -->
                <div class="space-y-6 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">Văn Bản Chính</h3>
                    <div>
                        <label class="font-semibold text-sm">Font chữ</label>
                        <div class="grid grid-cols-2 gap-2 choice-selector mt-2" id="main-font-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Kiểu Hiển Thị & Màu Sắc</label>
                        <div class="flex flex-col space-y-2 choice-selector mt-2" id="main-style-selector"></div>
                        <div class="grid grid-cols-4 gap-3 choice-selector mt-3" id="main-color-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Vị trí</label>
                        <div class="flex flex-col space-y-2 choice-selector mt-2" id="main-position-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Kích thước</label>
                        <div class="grid grid-cols-3 gap-2 choice-selector mt-2" id="size-selector"></div>
                    </div>
                </div>
                <!-- Cột phải: Ghi chú -->
                <div class="space-y-6 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">Ghi Chú</h3>
                     <div>
                        <label class="font-semibold text-sm">Font chữ</label>
                        <div class="grid grid-cols-2 gap-2 choice-selector mt-2" id="note-font-selector"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-sm">Kiểu Hiển Thị & Màu Sắc</label>
                        <div class="flex flex-col space-y-2 choice-selector mt-2" id="note-style-selector"></div>
                        <div class="grid grid-cols-4 gap-3 choice-selector mt-3" id="note-color-selector"></div>
                    </div>
                     <div>
                        <label class="font-semibold text-sm">Vị trí</label>
                        <div class="grid grid-cols-2 gap-2 choice-selector mt-2" id="note-position-selector"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Nhập Nội Dung -->
        <section>
            <h2 class="text-xl font-bold text-gray-800 mb-4">Bước 2: Nhập Nội Dung muốn chèn lên ảnh</h2>
            <div class="space-y-4">
                <div>
                    <label for="text1" class="block text-sm font-medium text-gray-700">Nội dung chính</label>
                    <textarea id="text1" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Đây là phần nội dung Sư Huynh muốn trợ lý chèn lên hình ảnh..."></textarea>
                </div>
                <div>
                    <label for="text3" class="block text-sm font-medium text-gray-700">Ghi chú (Nguồn, ngày tháng...)</label>
                    <input type="text" id="text3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Nguồn bài viết, ví dụ : Wenda...">
                </div>
            </div>
        </section>

        <!-- 3. Tạo ảnh -->
        <button id="generateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-wait" disabled>
            <span id="btn-text">Đang tải Font chữ...</span>
        </button>
    </main>

    <!-- Loading Modal -->
    <div id="loading-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white rounded-lg p-8 text-center space-y-4">
            <div class="loader mx-auto"></div>
            <p class="text-indigo-600 font-semibold text-lg">Đang tạo ảnh cho Sư Huynh...</p>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 opacity-0 pointer-events-none">
        <div class="bg-white rounded-lg p-6 space-y-4 w-full max-w-lg">
            <h3 class="text-2xl font-bold text-center text-indigo-600">Tác phẩm đã hoàn thành!</h3>
            <canvas id="resultCanvas" class="w-full h-auto rounded-lg shadow-md"></canvas>
            <div class="flex flex-col sm:flex-row gap-4">
                <a id="downloadBtn" href="#" download="thiep-anh.png" class="flex-1 text-center bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition">Tải Về</a>
                <button id="closeBtn" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition">Đóng</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- CÁC PHẦN TỬ DOM ---
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btn-text');
        const mainFontSelectorContainer = document.getElementById('main-font-selector');
        const noteFontSelectorContainer = document.getElementById('note-font-selector');
        const mainStyleSelectorContainer = document.getElementById('main-style-selector');
        const noteStyleSelectorContainer = document.getElementById('note-style-selector');
        const sizeSelectorContainer = document.getElementById('size-selector');
        const mainPositionSelectorContainer = document.getElementById('main-position-selector');
        const notePositionSelectorContainer = document.getElementById('note-position-selector');
        const mainColorSelectorContainer = document.getElementById('main-color-selector');
        const noteColorSelectorContainer = document.getElementById('note-color-selector');
        const textInputs = { text1: document.getElementById('text1'), text3: document.getElementById('text3') };
        
        const loadingModal = document.getElementById('loading-modal');
        const resultModal = document.getElementById('result-modal');
        const closeBtn = document.getElementById('closeBtn');
        const canvas = document.getElementById('resultCanvas');
        const downloadBtn = document.getElementById('downloadBtn');
        const ctx = canvas.getContext('2d');

        // --- ĐỊNH NGHĨA CÁC BỘ FONT, MÀU, VỊ TRÍ, KÍCH THƯỚC ---
        const fontProfiles = [
            { id: 'font1', name: 'Roboto', main: "'Roboto', sans-serif" },
            { id: 'font2', name: 'Be Vietnam Pro', main: "'Be Vietnam Pro', sans-serif" },
            { id: 'font3', name: 'Playfair Display', main: "'Playfair Display', serif" },
            { id: 'font4', name: 'Times New Roman', main: "'Times New Roman', serif" },
            { id: 'font5', name: 'Arial', main: "Arial, sans-serif" },
        ];
        const styleProfiles = [
            { id: 'styleBox', name: 'Hộp Nền Tối', method: 'drawTextBox', boxColor: 'rgba(40, 26, 1, 0.8)' },
            { id: 'styleGlow', name: 'Chữ Nổi Bật', method: 'drawGlowedText' },
        ];
        const boxTextColors = [
            { name: 'Trắng', value: '#FFFFFF' }, { name: 'Vàng Nhạt', value: '#FEFCE8' },
            { name: 'Hồng Sáng', value: '#FCE7F3' }, { name: 'Xanh Sáng', value: '#ECFEFF' },
        ];
        const glowTextColors = [
            { name: 'Trắng', value: '#FFFFFF', outline: '#000000' }, { name: 'Đen', value: '#111827', outline: '#F3F4F6' },
            { name: 'Vàng Kim', value: '#FBBF24', outline: '#422006' }, { name: 'Hồng Phấn', value: '#FBCFE8', outline: '#831843' },
            { name: 'Xanh Trời', value: '#A5F3FC', outline: '#0E7490' }, { name: 'Xanh Lá', value: '#BEF264', outline: '#365314' },
            { name: 'Tím', value: '#D8B4FE', outline: '#581C87' }, { name: 'Cam', value: '#FDBA74', outline: '#7C2D12' },
        ];
        const mainPositionProfiles = [
            { id: 'posTop', name: 'Ở Trên', value: 'top' },
            { id: 'posCenter', name: 'Ở Giữa', value: 'center' },
            { id: 'posBottom', name: 'Ở Dưới', value: 'bottom' },
        ];
        const notePositionProfiles = [
            { id: 'noteTopLeft', name: 'Trên Trái', value: 'topLeft' },
            { id: 'noteTopRight', name: 'Trên Phải', value: 'topRight' },
            { id: 'noteBottomLeft', name: 'Dưới Trái', value: 'bottomLeft' },
            { id: 'noteBottomRight', name: 'Dưới Phải', value: 'bottomRight' },
        ];
        const sizeProfiles = [
            { id: 'size30', name: '30px', value: 30 }, { id: 'size40', name: '40px', value: 40 },
            { id: 'size50', name: '50px', value: 50 }, { id: 'size60', name: '60px', value: 60 },
            { id: 'size70', name: '70px', value: 70 },
        ];
        
        // --- KHỞI TẠO GIAO DIỆN & TẢI FONT ---
        async function loadFonts() {
            const fontChecks = fontProfiles.map(p => document.fonts.load(`700 12px ${p.main}`));
            try {
                await Promise.all(fontChecks);
                console.log("Tất cả font đã được tải thành công!");
                generateBtn.disabled = false;
                btnText.textContent = "TẠO HÌNH ẢNH";
            } catch (err) {
                console.error("Lỗi khi tải font:", err);
                btnText.textContent = "Lỗi tải font, vui lòng làm mới";
            }
        }

        function initializeUI() {
            // Font Selectors
            const createFontSelector = (container, name, defaultIndex) => {
                container.innerHTML = ''; // Clear previous options
                fontProfiles.forEach((profile, index) => {
                    container.innerHTML += `
                        <div>
                            <input type="radio" name="${name}" id="${name}-${profile.id}" value="${profile.id}" class="hidden" ${index === defaultIndex ? 'checked' : ''}>
                            <label for="${name}-${profile.id}" class="block cursor-pointer border-2 border-gray-200 rounded-lg p-2 text-center transition hover:border-indigo-500 h-full">
                                <div style="font-family: ${profile.main}; font-size: 1.2rem; line-height: 1.2;">${profile.name}</div>
                            </label>
                        </div>`;
                });
            };
            createFontSelector(mainFontSelectorContainer, 'main-font', 0);
            createFontSelector(noteFontSelectorContainer, 'note-font', 3);

            // Style & Color Selectors
            const createStyleAndColorSelectors = (styleContainer, colorContainer, namePrefix, defaultIndex) => {
                const populateColors = (styleId) => {
                    colorContainer.innerHTML = '';
                    const colors = styleId === 'styleBox' ? boxTextColors : glowTextColors;
                    colors.forEach((color, index) => {
                        colorContainer.innerHTML += `
                            <div>
                                <input type="radio" name="${namePrefix}-color" id="${namePrefix}-color-${index}" value='${JSON.stringify(color)}' class="hidden" ${index === 0 ? 'checked' : ''}>
                                <label for="${namePrefix}-color-${index}" title="${color.name}" class="flex flex-col items-center cursor-pointer rounded-lg p-1 transition">
                                    <div class="color-swatch" style="background-color: ${color.value};"></div>
                                </label>
                            </div>`;
                    });
                };

                styleContainer.addEventListener('change', (e) => {
                    if (e.target.name === `${namePrefix}-style`) {
                        populateColors(e.target.value);
                    }
                });

                styleProfiles.forEach((style, index) => {
                    styleContainer.innerHTML += `
                        <div>
                            <input type="radio" name="${namePrefix}-style" id="${namePrefix}-${style.id}" value="${style.id}" class="hidden" ${index === defaultIndex ? 'checked' : ''}>
                            <label for="${namePrefix}-${style.id}" class="block cursor-pointer border-2 border-gray-200 rounded-lg p-2 text-center transition hover:border-indigo-500 font-medium">${style.name}</label>
                        </div>`;
                });
                populateColors(styleProfiles[defaultIndex].id);
            };
            
            createStyleAndColorSelectors(mainStyleSelectorContainer, mainColorSelectorContainer, 'main', 0);
            createStyleAndColorSelectors(noteStyleSelectorContainer, noteColorSelectorContainer, 'note', 1);

            // Size Selector
            sizeProfiles.forEach((size, index) => {
                sizeSelectorContainer.innerHTML += `
                    <div>
                        <input type="radio" name="size" id="${size.id}" value="${size.value}" class="hidden" ${index === 2 ? 'checked' : ''}>
                        <label for="${size.id}" class="block cursor-pointer border-2 border-gray-200 rounded-lg p-2 text-center transition hover:border-indigo-500 font-medium">${size.name}</label>
                    </div>`;
            });
            // Main Position Selector
            mainPositionProfiles.forEach((pos, index) => {
                mainPositionSelectorContainer.innerHTML += `
                    <div>
                        <input type="radio" name="main_position" id="${pos.id}" value="${pos.value}" class="hidden" ${index === 1 ? 'checked' : ''}>
                        <label for="${pos.id}" class="block cursor-pointer border-2 border-gray-200 rounded-lg p-2 text-center transition hover:border-indigo-500 font-medium">${pos.name}</label>
                    </div>`;
            });
            // Note Position Selector
            notePositionProfiles.forEach((pos, index) => {
                notePositionSelectorContainer.innerHTML += `
                    <div>
                        <input type="radio" name="note_position" id="${pos.id}" value="${pos.value}" class="hidden" ${index === 0 ? 'checked' : ''}>
                        <label for="${pos.id}" class="block cursor-pointer border-2 border-gray-200 rounded-lg p-2 text-center transition hover:border-indigo-500 font-medium">${pos.name}</label>
                    </div>`;
            });
            
            loadFonts();
        }

        initializeUI();

        // --- HÀM CHÍNH ---
        generateBtn.addEventListener('click', async () => {
            const options = {
                main: {
                    fontId: document.querySelector('input[name="main-font"]:checked').value,
                    styleId: document.querySelector('input[name="main-style"]:checked').value,
                    size: parseInt(document.querySelector('input[name="size"]:checked').value, 10),
                    position: document.querySelector('input[name="main_position"]:checked').value,
                    color: JSON.parse(document.querySelector('input[name="main-color"]:checked').value),
                },
                note: {
                    fontId: document.querySelector('input[name="note-font"]:checked').value,
                    styleId: document.querySelector('input[name="note-style"]:checked').value,
                    position: document.querySelector('input[name="note_position"]:checked').value,
                    color: JSON.parse(document.querySelector('input[name="note-color"]:checked').value),
                }
            };
            const texts = { text1: textInputs.text1.value, text3: textInputs.text3.value.trim() };
            if (!texts.text1 && !texts.text3) { alert("Bạn chưa nhập nội dung nào cả!"); return; }

            showModal(loadingModal);
            try {
                const prompt = generateLotusPrompt(); 
                const imageDataURL = await queryStabilityAPI(prompt);
                await drawImageWithLayout(imageDataURL, options, texts);
                hideModal(loadingModal);
                showModal(resultModal);
            } catch (error) {
                hideModal(loadingModal);
                alert(`Đã có lỗi xảy ra: ${error.message}`);
                console.error('Lỗi:', error);
            }
        });

        closeBtn.addEventListener('click', () => hideModal(resultModal));

        // --- HỆ THỐNG BỐ CỤC ĐỘNG ---
        async function drawImageWithLayout(imageDataURL, options, texts) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                image.src = imageDataURL;
                image.onload = () => {
                    const size = Math.min(image.width, image.height);
                    canvas.width = size;
                    canvas.height = size;
                    const sx = (image.width - size) / 2;
                    const sy = (image.height - size) / 2;
                    ctx.drawImage(image, sx, sy, size, size, 0, 0, size, size);
                    
                    const mainFontProfile = fontProfiles.find(f => f.id === options.main.fontId);
                    const mainStyleProfile = styleProfiles.find(s => s.id === options.main.styleId);
                    const noteFontProfile = fontProfiles.find(f => f.id === options.note.fontId);
                    const noteStyleProfile = styleProfiles.find(s => s.id === options.note.styleId);

                    // Vẽ ghi chú (text3)
                    if (texts.text3) {
                        const noteBlock = {
                            size: 22,
                            font: noteFontProfile.main,
                            color: options.note.color.value,
                            boxColor: noteStyleProfile.boxColor,
                            outlineColor: options.note.color.outline,
                            position: options.note.position
                        };
                        const preparedNote = prepareTextBlock(ctx, texts.text3, noteBlock);
                        preparedNote.drawCall(noteStyleProfile.method);
                    }

                    // Vẽ nội dung chính (text1)
                    if (texts.text1) {
                        const mainBlock = {
                            size: options.main.size,
                            font: mainFontProfile.main,
                            color: options.main.color.value,
                            boxColor: mainStyleProfile.boxColor,
                            outlineColor: options.main.color.outline,
                            position: options.main.position
                        };
                        const preparedMain = prepareTextBlock(ctx, texts.text1, mainBlock);
                        preparedMain.drawCall(mainStyleProfile.method);
                    }

                    downloadBtn.href = canvas.toDataURL('image/png');
                    URL.revokeObjectURL(image.src);
                    resolve();
                };
                image.onerror = reject;
            });
        }

        function prepareTextBlock(ctx, text, block) {
            const { width, height } = ctx.canvas;
            const fontSize = block.size;
            
            ctx.font = `bold ${fontSize}px ${block.font}`;
            const lines = wrapText(ctx, text, width * 0.9);
            const lineHeight = fontSize * 1.3;
            const blockHeight = (lines.length * lineHeight);

            let startY, startX, textAlign;

            if (block.position.includes('Left')) {
                startX = width * 0.05;
                textAlign = 'left';
            } else if (block.position.includes('Right')) {
                startX = width * 0.95;
                textAlign = 'right';
            } else {
                startX = width / 2;
                textAlign = 'center';
            }

            if (block.position.includes('top')) {
                startY = height * 0.05;
            } else if (block.position.includes('bottom')) {
                startY = height - blockHeight - (height * 0.05);
            } else { // center
                startY = (height - blockHeight) / 2;
            }

            return {
                drawCall: (method) => {
                    ctx.textAlign = textAlign;
                    if (method === 'drawTextBox') {
                        drawTextBox(ctx, lines, startX, startY, lineHeight, fontSize, block);
                    } else {
                        drawGlowedText(ctx, lines, startX, startY, lineHeight, fontSize, block);
                    }
                }
            };
        }

        // --- CÁC HÀM VẼ CHI TIẾT ---
        function drawTextBox(ctx, lines, x, startY, lineHeight, fontSize, block) {
            const padding = fontSize * 0.4;
            lines.forEach((line, index) => {
                const textMetrics = ctx.measureText(line);
                const lineWidth = textMetrics.width;
                
                const bannerWidth = lineWidth + padding * 2;
                const bannerHeight = fontSize + padding;
                
                const currentLineY = startY + (index * lineHeight);
                const bannerX = x - (ctx.textAlign === 'center' ? bannerWidth / 2 : (ctx.textAlign === 'right' ? bannerWidth : 0));
                
                ctx.fillStyle = block.boxColor;
                ctx.beginPath();
                ctx.roundRect(bannerX, currentLineY, bannerWidth, bannerHeight, 10);
                ctx.fill();

                ctx.fillStyle = block.color;
                ctx.textBaseline = 'top';
                ctx.fillText(line, x, currentLineY + padding / 2);
            });
        }

        function drawGlowedText(ctx, lines, x, startY, lineHeight, fontSize, block) {
            ctx.textBaseline = 'top';
            ctx.shadowColor = block.outlineColor;
            ctx.fillStyle = block.color;
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            lines.forEach((line, index) => {
                ctx.fillText(line, x, startY + (index * lineHeight));
            });
            ctx.shadowColor = 'transparent';
        }

        // --- CÁC HÀM PHỤ ---
        function wrapText(ctx, text, maxWidth) {
            const finalLines = [];
            const initialLines = text.split('\n'); 

            initialLines.forEach(line => {
                const words = line.split(' ');
                let currentLine = words[0] || '';

                for (let i = 1; i < words.length; i++) {
                    const word = words[i];
                    const testLine = currentLine + " " + word;
                    if (ctx.measureText(testLine).width < maxWidth && word !== '') {
                        currentLine += " " + word;
                    } else {
                        finalLines.push(currentLine);
                        currentLine = word;
                    }
                }
                finalLines.push(currentLine);
            });
            return finalLines;
        }

        function showModal(modal) {
            modal.classList.remove('opacity-0', 'pointer-events-none');
        }
        function hideModal(modal) {
            modal.classList.add('opacity-0', 'pointer-events-none');
        }

        function setupLoadingUI() {
            showModal(loadingModal);
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function showResultUI() {
            hideModal(loadingModal);
            showModal(resultModal);
        }

        function generateLotusPrompt() {
            const base = "masterpiece, best quality, beautiful anime style illustration of a lotus flower, scenic, soft lighting, clean lines, square image";
            const styles = ["on a serene pond at sunrise", "in a mystical garden with cinematic light", "minimalist, clean lines, vibrant colors", "with a traditional asian temple in the background"];
            return `${base}, ${styles[Math.floor(Math.random() * styles.length)]}`;
        }

        // --- MODIFIED FUNCTION ---
        // This function now calls our own backend proxy server
        async function queryStabilityAPI(prompt) {
            // The API call is now directed to our own server endpoint
            const response = await fetch(`/api/generate-image`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: prompt }), // Send the prompt in the body
            });

            if (!response.ok) {
                const errorResult = await response.json();
                throw new Error(`Lỗi từ máy chủ: ${errorResult.error || 'Không rõ lỗi'}`);
            }

            const responseJSON = await response.json();
            if (!responseJSON.artifacts || responseJSON.artifacts.length === 0) {
                 throw new Error('Không nhận được ảnh từ API.');
            }
            const imageBase64 = responseJSON.artifacts[0].base64;
            return `data:image/png;base64,${imageBase64}`;
        }
    </script>
</body>
</html>
